"use strict";angular.module("core").controller("auditCtrl",["$scope","$http","$rootScope","$uibModal","commonService","$timeout","$compile","$state",function(t,e,a,o,n,i,s,u){function r(e,a){"null"!=t.comSource&&""!=t.comSource||(t.comSource=null),$(".audit .table-body h4").length>=0&&$(".audit .table-body h4").remove(),layer.load(2,{shade:!1}),setTimeout(function(){layer.closeAll("loading")},10),n.aduitList(e).then(function(e){setTimeout(function(){layer.closeAll("loading")},10),t.statusCount=e.data.totalRowCount,t.auditList=e.data.itemList;0==t.auditList.length?($(".audit .pagination").hide(),$(".audit .table-body").append("<h4 style='margin: 15% 0 0 43%;'>没有找到相关构件</h4>")):$(".audit .pagination").show(),l(t.auditList),d(t.auditList),t.bigTotalItems=e.data.totalRowCount,componentListUpdata(),"function"==typeof a&&a()})}function l(t){t.map(function(t){0==t.attachment.length&&(t.attachment[0]={},t.attachment[0].displayUrl="imgs/placeholder.png")})}function p(e){t.statusCheck=null==e?"记录":1==e?"待审核":2==e?"已通过":"未通过"}function d(t){angular.forEach(t,function(t,e,a){1==t.status&&(t.status="待审核"),2==t.status&&(t.status="已通过"),3==t.status&&(t.status="未通过")})}function c(){return h=$(".dump-inp input").val()}t.sidebar="audit",t.flag={},t.status=null,t.isUpload=!1;var m=ApplicationConfiguration.pagesize.pageSize;t.pageSize=m,window.onresize=function(){$(".tableBody").css("width",$(".container-fluid").css("width"))},function(){layer.load(2,{shade:!1}),n.aduitList({status:null,componentDisplayName:"",originEpId:null,order:"DESC",currentPage:1,pageSize:m}).then(function(e){setTimeout(function(){layer.closeAll("loading")},10),t.bigTotalItems=e.data.totalRowCount,t.statusCount=e.data.totalRowCount,t.auditList=e.data.itemList,l(t.auditList),componentListUpdata(),d(t.auditList),0==t.auditList.length?($(".audit .pagination").hide(),$(".audit .table-body").append("<h4 style='margin: 15% 0 0 43%;'>没有找到相关构件</h4>")):$(".audit .pagination").show()}),t.statusCheck="记录",t.order="DESC",t.status=null,t.searchText="",t.comSource=null,t.currentPage=1}(),n.getPermis().then(function(e){var a=e.data;2==BzCloudComp.GetEpType()&&""!=a&&(t.orgShow=!0),a=a.split(";");for(var o=0;o<a.length;o++)"30002001"==a[o]&&(t.isUpload=!0)});var g={};window.componentListUpdata=function(){t.auditList.map(function(t){var e=BzCloudComp.GetCompType(t.subClassName,t.guid,t.md5,t.epId-0,t.originEpId-0,t.lastestClientVersion,t.componentId);0==e?(t.nUpload=!0,t.yUpload=!1):1==e?(t.nUpload=!0,t.yUpload=!1):2==e?(t.nUpload=!1,t.yUpload=!0):3==e?(t.nUpload=!1,t.yUpload=!1,t.versonHigh=!0):e<0&&(t.proContiner=!0,t.nUpload=!1,t.yUpload=!1)}),t.$$phase||t.$apply()},t.apply=function(t,e,a,o){BzCloudComp.UseComp(t,e,a,o)},t.sourceStatus=BzCloudComp.GetEpType(),t.search=function(e,a){if(e&&13!=e.keyCode&&10!=e.keyCode)return!1;t.searchText=a,r(g={status:t.status,componentDisplayName:a,originEpId:t.comSource,order:"DESC",currentPage:1,pageSize:m}),p(t.status)},n.getSourceList().then(function(e){t.sourceList=e.data}),t.companySelect=function(e){var a=e;"null"==a&&(a=null),"string"==typeof a&&parseInt(a),t.comSource=a,r(g={status:t.status,componentDisplayName:t.searchText,originEpId:a,order:"DESC",currentPage:1,pageSize:m}),p(t.status)},t.getComponent=function(e){$(".table-list label>input").prop("checked",!1),t.currentPage=1,t.status=e,""!=e&&void 0!=e||(e=null),r(g={status:e,componentDisplayName:t.searchText,originEpId:t.comSource,order:"DESC",currentPage:1,pageSize:m}),p(e)},$("body").off("click"),$("body").on("click",function(e){$(e.target).hasClass("aduitStatus")||$(e.target).parents(".aduitStatus").length||!t.listStatusArr||(t.listStatusArr.map(function(t){console.log(t),$(".aduitStatus ul").hide(),t.listStatus=!1}),t.listStatusArr=[])}),t.showAudit=function(e,a,o){if(t.listStatusArr||(t.listStatusArr=[]),t.listStatusArr.map(function(t){$(".aduitStatus ul").hide(),t.listStatus=!1}),t.listStatusArr=[],$(".aduitStatus ul").show(),"待审核"==e)return t.listStatusArr.push(o),!a},t.getAuditList=function(e,a){t.flag.auditStatus=!1,t.listStatus=!1,n.auditStatus({componentIds:[a],status:e}).then(function(e){r(g={status:t.status,componentDisplayName:t.searchText,originEpId:t.comSource,order:"DESC",currentPage:t.currentPage,pageSize:m}),p(t.status)})},t.flag.auditStatus=!1,t.editAudit=function(){t.flag.auditStatus=!t.flag.auditStatus,$(".audit .edi .glyphicon-menu-down").css({transform:"rotate(180deg)"})},t.setPage=function(e){t.currentPage=e},t.pageChanged=function(e){t.auditList=[],r(g={status:t.status,componentDisplayName:t.searchText,originEpId:t.comSource,order:"DESC",currentPage:e,pageSize:m}),p(t.status)},t.maxSize=5;var h;t.getDumpOk=function(e,a){if(e&&13!=e.keyCode)return!1;var o=parseInt(c());if(o>a)return alert("查询页码超出范围，请重新输入"),$(".dump-inp input").val(""),!1;t.setPage(c()),r(g={status:t.status,componentDisplayName:t.searchText,originEpId:t.comSource,order:"DESC",currentPage:o,pageSize:m}),p(t.status),t.currentPage=o,$(".dump-inp input").val("")},t.allSelected=function(){$(".table-list label>input").prop("checked",!0)},t.invertSelected=function(){$(".table-list label>input").each(function(){$(this).prop("checked",!$(this).prop("checked"))})},t.downMuch=function(){for(var e=[],a={},o=[],n={},i=$("input:checked"),s=0;s<i.length;s++){var u=$(i[s]).parent().parent().parent().attr("data-id");a={id:(u=u.split(","))[0],epId:u[1],orgEpId:u[2],epName:u[3],orgEpName:u[4]},n={id:u[0],epId:u[1],orgEpId:u[2]},"inline-block"==$(i[s]).parent().parent().parent().find(".proTd").children(".nUpload").css("display")&&(e.push(a),o.push(n))}0!=e.length&&(BzCloudComp.BatchDownloadComp(JSON.stringify(e)),$(".table-list label>input").prop("checked",!1),t.auditList.map(function(t){for(var a={epId:t.epId.toString(),id:t.componentId.toString(),orgEpId:t.originEpId.toString()},o=0;o<e.length;o++)a.id==e[o].id&&a.epId==e[o].epId&&a.orgEpId==e[o].orgEpId&&(t.nUpload=!1,t.proContiner=!0)}))},t.getAuditLists=function(e){t.flag.auditStatus=!1;for(var a=[],o=$("input:checked"),i=0;i<o.length;i++){var s=$(o[i]).parent().parent().parent().attr("ids");a.push(parseInt(s))}console.log(a),0!=a.length&&(n.auditStatus({componentIds:a,status:e}).then(function(e){r(g={status:t.status,componentDisplayName:t.searchText,originEpId:t.comSource,order:"DESC",currentPage:t.currentPage,pageSize:m}),p(t.status)}),$(".table-list label>input").prop("checked",!1))},$(document).click(function(e){if($(e.target).attr("class")&&-1!==$(e.target).attr("class").indexOf("pop-signal"))return!1;t.flag.auditStatus&&(t.flag.auditStatus=!1,t.$apply()),t.listStatus&&(t.listStatus=!1,t.$apply())}),$(document).click(function(e){t.listStatus&&(t.listStatus=!1,t.$apply())}),t.orderList=function(e){var a=void 0;a=$(e.target).hasClass("glyphicon")?$(e.target).parent():$(e.target),$(a).toggleClass("showOrder"),1==$(".showOrder").length?(r(g={status:t.status,componentDisplayName:t.searchText,originEpId:t.comSource,order:"ASC",currentPage:t.currentPage,pageSize:m}),t.order="ASC"):(r(g={status:t.status,componentDisplayName:t.searchText,originEpId:t.comSource,order:"DESC",currentPage:t.currentPage,pageSize:m}),t.order="DESC")},t.showModal=function(e,a,n){t.items={componentId:e,opinion:a,status:n},o.open({windowClass:"component-modal audit-modal",backdrop:"static",animation:!1,size:"lg",templateUrl:"template/core/modalAudit.html",controller:"modalAuditCtrl",resolve:{items:function(){return t.items}}}).result.then(function(e){t.selected=e,i(function(){r(g={status:t.status,componentDisplayName:t.searchText,originEpId:t.comSource,order:"DESC",currentPage:t.currentPage,pageSize:m})},300)},function(){})},t.uploadCom=function(){if(BzCloudComp.GetVersion){if(console.log("新版本"),""==BzCloudComp.GetUpLoadDetail())return document.title="提示",void alert("当前无可上传构件!");o.open({windowClass:"uploadCom-modal",backdrop:"static",animation:!1,size:"lg",templateUrl:"template/component/uploadCom.html",controller:"uploadComCtrl",resolve:{items:function(){return t.items}}}).result.then(function(e){t.selected=e},function(){})}else alert("客户端版本过低，请升级到最新版本！")},t.down=function(t,e,a,o,n,i,s,u,r,l,p){p.nUpload=!1,p.proContiner=!0,BzCloudComp.DownloadComp(t,e,a,o,n);BzCloudComp.GetCompType(i,s,u,e,a,r)},$(".return-top").click(function(){$(".componet-base-main").animate({scrollTop:0},500)}),n.heartBeat()}]);